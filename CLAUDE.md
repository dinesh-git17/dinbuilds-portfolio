# CLAUDE.md — Engineering Contract

**Project:** Focus OS — Spatial Portfolio
**Stack:** Next.js 16 (App Router), React 19, Tailwind CSS v4, Framer Motion 5, Zustand
**Tooling:** Biome (Linting/Formatting), Vitest
**Package Manager:** pnpm (strict usage)
**Architecture:** OS-Domain Architecture (Core System vs. Installed Apps)

---

## 1. Non-Negotiable Rules

### 1.1 TypeScript Strictness

- `strict: true` is immutable.
- `any` is strictly banned. Use `unknown` and narrow types.
- **Props Interfaces:** Must be exported as `{ComponentName}Props`.
- **Zustand Stores:** All stores must be typed explicitly with `State` and `Actions` interfaces.
- `as` assertions require inline comment justification explaining why the type system cannot infer correctness.

### 1.2 Code Hygiene (Biome Standard)

- **Linter:** Biome is the authority. No ESLint/Prettier configuration overrides.
- **Console:** `console.log` is banned in committed code.
- **Dead Code:** No commented-out blocks. Git history is the backup.
- **Magic Strings:** Banned. Use `AppID` enums or constant config maps for window identifiers.
- **Imports:** Sorted by depth via Biome. Absolute imports (`@/os/...`, `@/apps/...`) mandatory.

### 1.3 Performance & Motion (The "60fps" Rule)

- **Layout Thrashing:** Strictly forbidden. Do not read/write DOM properties in the same frame.
- **Animation Strategy:**
    - Use `framer-motion` for all interactions.
    - Prefer `transform` (x, y, scale) over layout properties (width, top, left) to ensure GPU acceleration.
    - Use `layoutId` for morphing transitions (Desktop ↔ Mobile), but test strictly for performance regressions.
- **Re-renders:** The `WindowManager` component must NOT re-render when the `Clock` updates. Use granular Zustand selectors `useStore(state => state.specificValue)`.

### 1.4 Accessibility (WCAG AA)

- **Focus Management:** When a Window opens, focus moves to it. When closed, focus returns to the Dock icon.
- **Keyboard Navigation:** The Dock must be navigable via Arrow Keys.
- **Reduced Motion:** Respect `prefers-reduced-motion` by disabling window fly-in animations and morph effects.
- **ARIA:** All "icon-only" buttons (Dock items) must have `aria-label` or `sr-only` text.

### 1.5 Living Documentation

- This file (`CLAUDE.md`) is the **Single Source of Truth**.
- If architectural decisions change, this document must be updated *before* code is written.

### 1.6 AI Attribution (Strictly Forbidden)

- Zero tolerance for AI disclosure in source code or version control.
- Commit messages and PRs must be written in the voice of a Senior Product Engineer.
- No "Generated by..." comments.

---

## 2. Git Workflow

### 2.1 Branch Strategy

- **Main:** Protected. Production-ready code only.
- **Feature Branches:** `feat/os-core`, `feat/app-yield`, `feat/mobile-feed`.
- **Fix Branches:** `fix/window-drag`, `fix/z-index`.

### 2.2 Atomic Commits

- Format: Conventional Commits (`<type>(<scope>): <subject>`).
- Types: `feat`, `fix`, `perf`, `refactor`, `style`, `chore`.
- Scopes: `os`, `dock`, `window`, `apps`, `infra`.
- Example: `feat(window): implement snap-to-grid dragging logic`

---

## 3. Architecture & Directory Structure

We use a "System vs. Apps" separation to emulate an operating system structure.

```text
src/
├── app/                  # Routing layer (Entry points only)
├── features/
│   ├── os/               # The "System"
│   │   ├── desktop/      # Dock, Stage, Background
│   │   ├── mobile/       # Bento Grid, Feed Logic
│   │   ├── window/       # WindowManager, WindowFrame, Controls
│   │   └── store/        # Zustand (useSystemStore)
│   └── apps/             # The "Installed Software"
│       ├── yield/        # Yield Project Components
│       ├── debate/       # Debate Lab Components
│       └── terminal/     # PassFX Terminal Emulator
├── components/           # Primitives (Button, Slider, Tooltip) - Shadcn/Radix
├── lib/                  # Shared utilities (Time, Math, Strings)
└── styles/               # Global CSS variables (Themes)
```

**Rule:** `features/apps` cannot import from `features/os`. The OS imports the Apps, not vice-versa.

---

## 4. Component Standards

### 4.1 Window Components (The OS)

Windows are "Smart" containers.

```tsx
import { memo } from "react";
import { motion } from "framer-motion";
import { useSystemStore } from "@/features/os/store";

export interface WindowFrameProps {
  id: string;
  title: string;
  children: React.ReactNode;
  isActive: boolean;
}

export const WindowFrame = memo(function WindowFrame({
  id,
  title,
  children,
  isActive
}: WindowFrameProps) {
  const closeWindow = useSystemStore(s => s.closeWindow);

  return (
    <motion.div
      drag
      dragMomentum={false}
      className={cn(
        "absolute rounded-lg border border-white/10 bg-black/60 backdrop-blur-xl",
        isActive ? "z-50 shadow-glow" : "z-10"
      )}
      initial={{ scale: 0.9, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
    >
      <header className="flex h-10 items-center border-b border-white/5 px-4">
         <span className="font-mono text-xs text-white/50">{title}</span>
      </header>
      {children}
    </motion.div>
  );
});
```

### 4.2 App Manifests (The Content)

Every project is defined as an App Manifest object, not just a component.

```typescript
export const YIELD_APP_MANIFEST = {
  id: "app.yield",
  name: "Yield",
  icon: <BarChartIcon />,
  windowSize: { w: 800, h: 600 },
  component: lazy(() => import("./YieldApp")),
};
```

---

## 5. Styling Standards

- **Engine:** Tailwind CSS v4.
- **Variables:** Use CSS variables for "Deep Dark" theme tokens.
- **Glassmorphism:** Standardize the glass effect.
  - Class: `bg-black/40 backdrop-blur-md border border-white/10`
- **Typography:** Geist Sans for UI, Geist Mono for code/terminal.

---

## 6. Testing Strategy

**Tooling:** Vitest + React Testing Library.

### 6.1 Unit Tests (Logic)

- Test the `useSystemStore`:
    - Opening a window adds it to the stack.
    - Focusing a window moves it to the end of the array (top Z-index).
    - Closing the last window clears the active ID.

### 6.2 Component Tests (Interaction)

- Verify that clicking the "Dock" icon triggers the window open action.
- Verify Drag interactions (mocked) do not break layout.

---

## 7. Security & Headers

### 7.1 Security Headers

All routes serve strict headers in `next.config.ts`:

- **Content-Security-Policy (CSP):**
  - `script-src`: self, Vercel Analytics.
  - `frame-ancestors`: 'none' (Portfolio cannot be embedded).
- **Permissions-Policy:** Disable camera, mic, geolocation.

### 7.2 Input Validation

- **Contact Forms:** Zod validation for all inputs on the Server Action level.
- **Sanitization:** No user-generated content is rendered, but `dangerouslySetInnerHTML` is still banned unless strictly necessary for syntax highlighting (e.g., Shiki).

---

**END OF CONTRACT**
This document governs all engineering decisions for Focus OS.